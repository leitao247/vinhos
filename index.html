<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Wine Bringing — Harmonização Premium</title>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet"/>
  <style>
    :root {
      --bg: #0c0a09;
      --surface: #1c1917;
      --card: #231e1b;
      --card-hover: #2e2723;
      --wine: #8b2635;
      --wine-light: #a63446;
      --wine-dark: #6b1d2a;
      --gold: #c9a050;
      --gold-light: #d4b76a;
      --gold-dim: rgba(201,160,80,0.12);
      --text: #f5ede6;
      --text-sec: #9a8f85;
      --text-dim: #6b6158;
      --radius: 14px;
      --shadow: 0 8px 32px rgba(0,0,0,0.35);
    }

    * { box-sizing: border-box; margin: 0; padding: 0 }

    body {
      font-family: 'Inter', system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }

    h1, h2, h3 { font-family: 'Playfair Display', Georgia, serif }

    /* ===== NAV ===== */
    nav {
      position: sticky; top: 0; z-index: 100;
      background: rgba(12,10,9,0.92);
      backdrop-filter: blur(16px);
      border-bottom: 1px solid var(--gold-dim);
      padding: 0 24px;
    }
    .nav-inner {
      max-width: 1100px; margin: 0 auto;
      display: flex; align-items: center; justify-content: space-between;
      height: 64px;
    }
    .brand {
      display: flex; align-items: center; gap: 10px;
      font-family: 'Playfair Display', serif;
      font-size: 1.25rem; font-weight: 700; color: var(--gold);
      letter-spacing: 0.5px;
    }
    .brand svg { width: 28px; height: 28px; fill: var(--wine-light) }
    .nav-tabs {
      display: flex; gap: 4px;
      background: var(--surface); border-radius: 10px; padding: 4px;
    }
    .nav-tab {
      padding: 8px 20px; border-radius: 8px; border: none;
      background: transparent; color: var(--text-sec);
      font-size: 0.88rem; font-weight: 500; cursor: pointer;
      transition: all 0.25s;
    }
    .nav-tab.active { background: var(--wine); color: #fff }
    .nav-tab:hover:not(.active) { color: var(--text) }
    .cart-btn {
      position: relative; background: none; border: none;
      color: var(--gold); cursor: pointer; padding: 8px;
    }
    .cart-btn svg { width: 24px; height: 24px }
    .cart-badge {
      position: absolute; top: 2px; right: 0;
      background: var(--wine); color: #fff;
      font-size: 0.7rem; font-weight: 600;
      width: 18px; height: 18px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
    }
    .cart-badge:empty { display: none }

    /* ===== MAIN ===== */
    .container { max-width: 1100px; margin: 0 auto; padding: 28px 24px }

    .view { display: none }
    .view.active { display: block }

    /* ===== HERO ===== */
    .hero {
      text-align: center; padding: 40px 20px 32px;
      background: linear-gradient(180deg, rgba(139,38,53,0.15) 0%, transparent 100%);
      border-radius: var(--radius); margin-bottom: 28px;
    }
    .hero h1 { font-size: 2rem; color: var(--gold); margin-bottom: 8px }
    .hero p { color: var(--text-sec); font-size: 1rem; font-weight: 300 }

    /* ===== DIRECTION TOGGLE ===== */
    .direction-toggle {
      display: flex; justify-content: center; gap: 6px;
      margin-bottom: 28px;
      background: var(--surface); border-radius: 12px;
      padding: 5px; max-width: 480px; margin-left: auto; margin-right: auto;
    }
    .dir-btn {
      flex: 1; padding: 12px 16px; border: none; border-radius: 9px;
      background: transparent; color: var(--text-sec);
      font-size: 0.92rem; font-weight: 500; cursor: pointer;
      transition: all 0.25s;
    }
    .dir-btn.active {
      background: linear-gradient(135deg, var(--wine), var(--wine-dark));
      color: #fff; box-shadow: 0 4px 16px rgba(139,38,53,0.4);
    }

    /* ===== CONTROLS ===== */
    .controls-grid {
      display: grid; grid-template-columns: 1fr 1fr;
      gap: 20px; margin-bottom: 28px;
    }
    .control-group { display: flex; flex-direction: column; gap: 8px }
    .control-group label {
      font-size: 0.82rem; font-weight: 500; color: var(--gold);
      text-transform: uppercase; letter-spacing: 1px;
    }
    select, input[type="text"] {
      padding: 12px 16px; border-radius: 10px;
      border: 1px solid var(--gold-dim);
      background: var(--surface); color: var(--text);
      font-size: 0.95rem; font-family: inherit;
      transition: border-color 0.2s;
    }
    select:focus, input[type="text"]:focus {
      outline: none; border-color: var(--gold);
    }
    select option { background: var(--card); color: var(--text) }

    /* ===== CHIPS ===== */
    .chip-group {
      display: flex; gap: 8px; flex-wrap: wrap;
      margin-bottom: 20px; justify-content: center;
    }
    .chip-group-label {
      width: 100%; text-align: center;
      font-size: 0.78rem; color: var(--text-dim);
      text-transform: uppercase; letter-spacing: 1.5px;
      margin-bottom: 4px;
    }
    .chip {
      padding: 8px 18px; border-radius: 20px;
      border: 1px solid var(--gold-dim);
      background: transparent; color: var(--text-sec);
      font-size: 0.85rem; cursor: pointer; transition: all 0.2s;
    }
    .chip.active {
      background: var(--gold); color: var(--bg);
      border-color: var(--gold); font-weight: 600;
    }
    .chip:hover:not(.active) { border-color: var(--gold); color: var(--gold) }

    .btn-search {
      padding: 12px 28px; border-radius: 10px; border: none;
      background: linear-gradient(135deg, var(--wine), var(--wine-dark));
      color: #fff; font-size: 0.95rem; font-weight: 600;
      cursor: pointer; transition: all 0.25s;
      box-shadow: 0 4px 16px rgba(139,38,53,0.3);
    }
    .btn-search:hover { transform: translateY(-1px); box-shadow: 0 6px 20px rgba(139,38,53,0.45) }
    .btn-search:disabled { opacity: 0.5; cursor: not-allowed; transform: none }

    /* ===== RESULTS ===== */
    .results-title {
      font-family: 'Playfair Display', serif;
      font-size: 1.3rem; color: var(--gold);
      margin-bottom: 20px; text-align: center;
    }
    .status-msg {
      text-align: center; color: var(--text-sec);
      font-size: 0.9rem; padding: 20px;
    }

    /* ===== RECIPE CARD ===== */
    .recipe-grid {
      display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px; margin-bottom: 32px;
    }
    .recipe-card {
      background: var(--card); border-radius: var(--radius);
      overflow: hidden; border: 1px solid var(--gold-dim);
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .recipe-card:hover { transform: translateY(-3px); box-shadow: var(--shadow) }
    .recipe-card img {
      width: 100%; height: 220px; object-fit: cover;
      border-bottom: 2px solid var(--wine);
    }
    .recipe-card-body { padding: 16px }
    .recipe-card-title {
      font-family: 'Playfair Display', serif;
      font-size: 1.05rem; font-weight: 600; margin-bottom: 6px;
    }
    .recipe-card-cat {
      font-size: 0.8rem; color: var(--wine-light);
      text-transform: uppercase; letter-spacing: 0.8px; margin-bottom: 8px;
    }
    .recipe-card-desc {
      font-size: 0.88rem; color: var(--text-sec);
      line-height: 1.5; margin-bottom: 12px;
    }
    .recipe-link {
      color: var(--gold); font-size: 0.85rem;
      text-decoration: none; font-weight: 500;
    }
    .recipe-link:hover { text-decoration: underline }

    /* ===== WINE SUGGESTION CARDS ===== */
    .suggestions-section {
      margin-top: 32px; padding-top: 28px;
      border-top: 1px solid var(--gold-dim);
    }
    .wine-grid {
      display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 16px;
    }
    .wine-card {
      background: var(--card); border-radius: var(--radius);
      padding: 18px; border: 1px solid var(--gold-dim);
      display: flex; flex-direction: column; gap: 10px;
      transition: border-color 0.2s;
    }
    .wine-card:hover { border-color: var(--gold) }
    .wine-card-type {
      font-size: 0.72rem; text-transform: uppercase;
      letter-spacing: 1.2px; font-weight: 600;
      padding: 3px 10px; border-radius: 20px;
      display: inline-block; width: fit-content;
    }
    .type-tinto { background: rgba(139,38,53,0.3); color: #e8798a }
    .type-branco { background: rgba(201,160,80,0.2); color: var(--gold-light) }
    .type-rose { background: rgba(219,112,147,0.2); color: #f0a0b8 }
    .type-espumante { background: rgba(130,200,200,0.15); color: #90d4d4 }
    .type-porto { background: rgba(100,40,60,0.4); color: #d08090 }
    .type-doce { background: rgba(200,170,100,0.2); color: #d4c090 }
    .type-outro { background: rgba(150,150,150,0.15); color: #b0b0b0 }
    .wine-card-name {
      font-family: 'Playfair Display', serif;
      font-size: 0.95rem; font-weight: 600; line-height: 1.3;
    }
    .wine-card-region { font-size: 0.82rem; color: var(--text-sec) }
    .wine-card-grapes { font-size: 0.78rem; color: var(--text-dim); font-style: italic }
    .wine-card-bottom {
      display: flex; align-items: center; justify-content: space-between;
      margin-top: auto; padding-top: 10px;
      border-top: 1px solid rgba(255,255,255,0.04);
    }
    .wine-card-price {
      font-size: 1.1rem; font-weight: 700; color: var(--gold);
    }
    .btn-cart {
      padding: 8px 16px; border-radius: 8px; border: none;
      background: var(--wine); color: #fff;
      font-size: 0.82rem; font-weight: 600; cursor: pointer;
      transition: all 0.2s;
    }
    .btn-cart:hover { background: var(--wine-light) }
    .btn-cart.added { background: #166534; pointer-events: none }

    /* ===== CATALOG ===== */
    .catalog-filters {
      display: flex; gap: 12px; flex-wrap: wrap;
      margin-bottom: 24px; align-items: flex-end;
    }
    .catalog-filters .control-group { flex: 1; min-width: 180px }
    .catalog-count {
      font-size: 0.85rem; color: var(--text-dim);
      margin-bottom: 16px;
    }

    /* ===== CART ===== */
    .cart-empty {
      text-align: center; padding: 60px 20px; color: var(--text-sec);
    }
    .cart-empty svg { width: 64px; height: 64px; fill: var(--text-dim); margin-bottom: 16px }
    .cart-item {
      display: flex; align-items: center; gap: 16px;
      padding: 16px; background: var(--card);
      border-radius: var(--radius); border: 1px solid var(--gold-dim);
      margin-bottom: 12px;
    }
    .cart-item-info { flex: 1 }
    .cart-item-name { font-weight: 600; margin-bottom: 4px }
    .cart-item-region { font-size: 0.82rem; color: var(--text-sec) }
    .cart-item-price { color: var(--gold); font-weight: 600; font-size: 0.95rem }
    .cart-qty {
      display: flex; align-items: center; gap: 8px;
    }
    .cart-qty button {
      width: 32px; height: 32px; border-radius: 8px; border: 1px solid var(--gold-dim);
      background: var(--surface); color: var(--text);
      font-size: 1rem; cursor: pointer; display: flex;
      align-items: center; justify-content: center;
    }
    .cart-qty span {
      font-weight: 600; min-width: 24px; text-align: center;
    }
    .cart-remove {
      background: none; border: none; color: var(--text-dim);
      cursor: pointer; font-size: 0.82rem; padding: 4px 8px;
    }
    .cart-remove:hover { color: #ef4444 }
    .cart-total-bar {
      display: flex; justify-content: space-between; align-items: center;
      padding: 20px; background: var(--surface);
      border-radius: var(--radius); border: 1px solid var(--gold-dim);
      margin-top: 20px;
    }
    .cart-total-label { font-size: 1.1rem; font-weight: 500 }
    .cart-total-value {
      font-family: 'Playfair Display', serif;
      font-size: 1.5rem; font-weight: 700; color: var(--gold);
    }
    .btn-whatsapp {
      display: flex; align-items: center; justify-content: center; gap: 8px;
      width: 100%; padding: 16px; border-radius: 12px; border: none;
      background: #25d366; color: #fff;
      font-size: 1rem; font-weight: 600; cursor: pointer;
      margin-top: 16px; transition: background 0.2s;
    }
    .btn-whatsapp:hover { background: #20bd5a }

    /* ===== SPINNER ===== */
    .spinner-overlay {
      position: fixed; inset: 0; z-index: 999;
      background: rgba(12,10,9,0.7); backdrop-filter: blur(4px);
      display: flex; align-items: center; justify-content: center;
      visibility: hidden; opacity: 0; transition: all 0.2s;
    }
    .spinner-overlay.show { visibility: visible; opacity: 1 }
    .spinner-dots { display: flex; gap: 8px }
    .spinner-dots span {
      width: 12px; height: 12px; border-radius: 50%;
      background: var(--gold); animation: bounce 0.8s infinite ease-in-out;
    }
    .spinner-dots span:nth-child(2) { animation-delay: 0.1s }
    .spinner-dots span:nth-child(3) { animation-delay: 0.2s }
    @keyframes bounce {
      0%,100% { transform: translateY(0); opacity: 0.4 }
      50% { transform: translateY(-12px); opacity: 1 }
    }

    /* ===== RESPONSIVE ===== */
    @media (max-width: 768px) {
      .hero h1 { font-size: 1.5rem }
      .controls-grid { grid-template-columns: 1fr }
      .recipe-grid { grid-template-columns: 1fr }
      .wine-grid { grid-template-columns: 1fr }
      .nav-tabs { display: none }
      .nav-mobile { display: flex !important }
      .catalog-filters { flex-direction: column }
    }
    .nav-mobile {
      display: none; position: fixed; bottom: 0; left: 0; right: 0;
      background: rgba(12,10,9,0.95); backdrop-filter: blur(16px);
      border-top: 1px solid var(--gold-dim);
      padding: 8px 16px; gap: 4px; z-index: 100;
    }
    .nav-mobile .nav-tab { flex: 1; text-align: center; font-size: 0.78rem; padding: 10px 8px }
  </style>
</head>
<body>

  <nav>
    <div class="nav-inner">
      <div class="brand">
        <svg viewBox="0 0 24 24"><path d="M12 2C12 2 7 7 7 12c0 2.8 2.2 5 5 5s5-2.2 5-5C17 7 12 2 12 2zM11 19v3h2v-3h-2z"/></svg>
        Wine Bringing
      </div>
      <div class="nav-tabs">
        <button class="nav-tab active" data-view="harmonizar">Harmonizar</button>
        <button class="nav-tab" data-view="catalogo">Catálogo</button>
        <button class="nav-tab" data-view="carrinho">Carrinho</button>
      </div>
      <button class="cart-btn" data-view="carrinho" title="Carrinho">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/></svg>
        <span class="cart-badge" id="cartBadge"></span>
      </button>
    </div>
  </nav>
  <div class="nav-mobile">
    <button class="nav-tab active" data-view="harmonizar">Harmonizar</button>
    <button class="nav-tab" data-view="catalogo">Catálogo</button>
    <button class="nav-tab" data-view="carrinho">Carrinho</button>
  </div>

  <div class="container">

    <!-- ============ HARMONIZAR ============ -->
    <section id="viewHarmonizar" class="view active">
      <div class="hero">
        <h1>Harmonização Perfeita</h1>
        <p>Encontre o prato ideal para o seu vinho — ou o vinho perfeito para a sua receita.</p>
      </div>

      <div class="direction-toggle">
        <button class="dir-btn active" data-dir="wine2recipe">Vinho → Receita</button>
        <button class="dir-btn" data-dir="recipe2wine">Receita → Vinho</button>
      </div>

      <!-- Vinho → Receita -->
      <div id="panelWine2Recipe">
        <div class="controls-grid">
          <div class="control-group">
            <label>Selecione o Vinho</label>
            <select id="selWine"><option value="">— escolha um rótulo —</option></select>
          </div>
          <div class="control-group" style="justify-content:flex-end">
            <button class="btn-search" id="btnHarmonizar">Harmonizar</button>
          </div>
        </div>
        <div class="chip-group">
          <div class="chip-group-label">Variação do Prato</div>
          <button class="chip active" data-var="all">Todos</button>
          <button class="chip" data-var="peixe">Peixe</button>
          <button class="chip" data-var="carne">Carne</button>
          <button class="chip" data-var="vegano">Vegano</button>
        </div>
        <div class="chip-group">
          <div class="chip-group-label">Refeição</div>
          <button class="chip active" data-course="all">Todas</button>
          <button class="chip" data-course="entrada">Entrada</button>
          <button class="chip" data-course="principal">Principal</button>
          <button class="chip" data-course="sobremesa">Sobremesa</button>
        </div>
      </div>

      <!-- Receita → Vinho -->
      <div id="panelRecipe2Wine" style="display:none">
        <div class="controls-grid">
          <div class="control-group">
            <label>Buscar Receita</label>
            <input type="text" id="inputRecipe" placeholder="Ex.: salmon, pasta, chocolate cake..." />
          </div>
          <div class="control-group" style="justify-content:flex-end">
            <button class="btn-search" id="btnFindRecipe">Buscar</button>
          </div>
        </div>
      </div>

      <div id="harmonResults"></div>
    </section>

    <!-- ============ CATÁLOGO ============ -->
    <section id="viewCatalogo" class="view">
      <div class="hero">
        <h1>Nosso Catálogo</h1>
        <p>Explore nossa seleção premium de vinhos por país, região ou uva.</p>
      </div>

      <div class="catalog-filters">
        <div class="control-group">
          <label>País</label>
          <select id="filterCountry"><option value="">Todos</option></select>
        </div>
        <div class="control-group">
          <label>Região</label>
          <select id="filterRegion"><option value="">Todas</option></select>
        </div>
        <div class="control-group">
          <label>Tipo</label>
          <select id="filterType">
            <option value="">Todos</option>
            <option value="tinto">Tinto</option>
            <option value="branco">Branco</option>
            <option value="rose">Rosé</option>
            <option value="espumante">Espumante</option>
            <option value="porto">Porto</option>
            <option value="doce">Doce / Moscatel</option>
          </select>
        </div>
        <div class="control-group">
          <label>Buscar</label>
          <input type="text" id="filterSearch" placeholder="Nome ou uva..." />
        </div>
      </div>
      <div class="catalog-count" id="catalogCount"></div>
      <div class="wine-grid" id="catalogGrid"></div>
    </section>

    <!-- ============ CARRINHO ============ -->
    <section id="viewCarrinho" class="view">
      <div class="hero">
        <h1>Seu Carrinho</h1>
        <p>Revise suas escolhas e finalize o pedido.</p>
      </div>
      <div id="cartContent"></div>
    </section>

  </div>

  <div class="spinner-overlay" id="spinner">
    <div class="spinner-dots"><span></span><span></span><span></span></div>
  </div>

  <script>
    // ================================================================
    //  DATA & CONFIG
    // ================================================================

    const API_KEY = '1';
    const BASE = `https://www.themealdb.com/api/json/v1/${API_KEY}`;

    let allWines = [];
    let cart = JSON.parse(localStorage.getItem('wb_cart') || '[]');

    // Pairing: wine type → meal categories
    const PAIR_WINE_TO_MEAL = {
      tinto:     { cats: ['Beef','Lamb','Pork','Pasta'], terms: ['steak','beef','lamb'] },
      branco:    { cats: ['Seafood','Chicken'], terms: ['fish','seafood','chicken'] },
      rose:      { cats: ['Chicken','Starter','Seafood'], terms: ['salad','chicken','prawns'] },
      espumante: { cats: ['Starter','Seafood'], terms: ['appetizer','seafood'] },
      porto:     { cats: ['Dessert'], terms: ['chocolate','dessert'] },
      doce:      { cats: ['Dessert'], terms: ['dessert','fruit'] },
      outro:     { cats: ['Miscellaneous'], terms: ['meal'] }
    };

    // Reverse: meal category → wine types
    const PAIR_MEAL_TO_WINE = {
      Seafood: ['branco','rose','espumante'], Beef: ['tinto'], Lamb: ['tinto'],
      Pork: ['tinto','rose'], Chicken: ['branco','rose'], Pasta: ['tinto','branco'],
      Vegetarian: ['branco','rose'], Vegan: ['branco','rose'],
      Dessert: ['porto','doce','espumante'], Starter: ['espumante','branco','rose'],
      Miscellaneous: ['tinto','branco'], Goat: ['tinto'], Breakfast: ['espumante','branco'],
      Side: ['branco','rose']
    };

    // Variation → categories
    const VARIATION_CATS = {
      peixe: ['Seafood'],
      carne: ['Beef','Lamb','Pork','Chicken','Goat'],
      vegano: ['Vegetarian','Vegan']
    };

    // Course → categories
    const COURSE_CATS = {
      entrada: ['Starter','Side'],
      principal: null, // uses variation
      sobremesa: ['Dessert']
    };

    // ================================================================
    //  WINE DATA PROCESSING
    // ================================================================

    function detectWineType(name) {
      const n = name.toUpperCase();
      if (/\bESPUMANTE\b|\bFRISANTE\b|\bBRUT\b/.test(n)) return 'espumante';
      if (/\bPORTO\b/.test(n)) return 'porto';
      if (/\bMOSCATEL\b|\bPASSITO\b/.test(n)) return 'doce';
      if (/\bROS[EÉ]\b|\bROSATO\b|\bCHIARETO\b/.test(n)) return 'rose';
      if (/\bBCO\b|\bBRANCO\b|\bBIANCO\b|\bBLANC\b/.test(n)) return 'branco';
      if (/\bTTO\b|\bTINTO\b|\bROSSO\b|\bROUGE\b/.test(n)) return 'tinto';
      if (/PINOT GRIGIO|CHARDONNAY|SAUVIGNON|RIESLING|GARGANEGA|TURBIANA|ARINTO|LOUREIRO|ALVARINHO|VERDELHO|FERNÃO|FERNAO/.test(n)) return 'branco';
      if (/CABERNET|MERLOT|SYRAH|MONTEPULCIANO|SANGIOVESE|PRIMITIVO|NERO|BARBERA|TOURIGA|ARAGONEZ|BAGA|CASTEL[AÃ]O|TRINCADEIRA|ALICANTE/.test(n)) return 'tinto';
      return 'outro';
    }

    function extractGrapes(name) {
      const match = name.match(/\s+-\s+(.+?)(?:\s+\d{4})?\s*$/);
      if (match) return match[1].split(/[,;]/).map(g => g.trim()).filter(g => g.length > 1);
      return [];
    }

    function extractYear(name) {
      const match = name.match(/\b(20\d{2}|19\d{2})\b/);
      return match ? parseInt(match[1]) : null;
    }

    function cleanWineName(name) {
      return name.replace(/\s+-\s+.+$/, '').replace(/\s+\d{4}\s*$/, '').trim();
    }

    function parseOrigin(f) {
      const parts = f.split(/\s*-\s*/);
      return { country: (parts[0] || '').trim(), region: (parts[1] || '').trim() };
    }

    function processWines(raw) {
      return raw.map((w, i) => {
        const origin = parseOrigin(w.f);
        return {
          id: i,
          fullName: w.n,
          name: cleanWineName(w.n),
          type: detectWineType(w.n),
          country: origin.country,
          region: origin.region,
          grapes: extractGrapes(w.n),
          year: extractYear(w.n),
          price: w.t,
          priceCost: w.m
        };
      });
    }

    // ================================================================
    //  API HELPERS
    // ================================================================

    async function fetchJson(url) {
      const res = await fetch(url);
      if (!res.ok) throw new Error('Erro: ' + res.status);
      return res.json();
    }
    async function searchMeals(q) { return (await fetchJson(`${BASE}/search.php?s=${encodeURIComponent(q)}`)).meals || []; }
    async function filterByCategory(c) { return (await fetchJson(`${BASE}/filter.php?c=${encodeURIComponent(c)}`)).meals || []; }
    async function lookupMeal(id) { const d = await fetchJson(`${BASE}/lookup.php?i=${id}`); return d.meals ? d.meals[0] : null; }

    // ================================================================
    //  UI HELPERS
    // ================================================================

    const $ = id => document.getElementById(id);
    const spinner = $('spinner');

    function showSpinner() { spinner.classList.add('show') }
    function hideSpinner() { spinner.classList.remove('show') }
    async function withSpinner(fn) {
      try { showSpinner(); return await fn(); }
      finally { hideSpinner(); }
    }

    function formatBRL(v) {
      if (v == null || isNaN(v)) return '';
      return Number(v).toLocaleString('pt-BR', { style:'currency', currency:'BRL' });
    }
    function esc(s) {
      const m = {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'};
      return String(s||'').replace(/[&<>"']/g, c => m[c]);
    }

    const TYPE_LABELS = {
      tinto:'Tinto', branco:'Branco', rose:'Rosé', espumante:'Espumante',
      porto:'Porto', doce:'Doce', outro:'Outro'
    };

    function wineTypeTag(type) {
      return `<span class="wine-card-type type-${type}">${TYPE_LABELS[type] || type}</span>`;
    }

    // ================================================================
    //  NAVIGATION
    // ================================================================

    function switchView(name) {
      document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
      document.querySelectorAll('.nav-tab').forEach(t => {
        t.classList.toggle('active', t.dataset.view === name);
      });
      const view = $('view' + name.charAt(0).toUpperCase() + name.slice(1));
      if (view) view.classList.add('active');
    }

    document.querySelectorAll('[data-view]').forEach(btn => {
      btn.addEventListener('click', () => switchView(btn.dataset.view));
    });

    // Direction toggle
    document.querySelectorAll('.dir-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.dir-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        const isW2R = btn.dataset.dir === 'wine2recipe';
        $('panelWine2Recipe').style.display = isW2R ? '' : 'none';
        $('panelRecipe2Wine').style.display = isW2R ? 'none' : '';
        $('harmonResults').innerHTML = '';
      });
    });

    // Chips
    function setupChips(selector) {
      document.querySelectorAll(selector).forEach(chip => {
        chip.addEventListener('click', () => {
          chip.parentElement.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
          chip.classList.add('active');
        });
      });
    }
    setupChips('[data-var]');
    setupChips('[data-course]');

    // ================================================================
    //  CART
    // ================================================================

    function saveCart() { localStorage.setItem('wb_cart', JSON.stringify(cart)) }

    function addToCart(wineId) {
      const existing = cart.find(c => c.id === wineId);
      if (existing) existing.qty++;
      else cart.push({ id: wineId, qty: 1 });
      saveCart();
      updateCartBadge();
    }

    function removeFromCart(wineId) {
      cart = cart.filter(c => c.id !== wineId);
      saveCart();
      updateCartBadge();
      renderCart();
    }

    function updateCartQty(wineId, delta) {
      const item = cart.find(c => c.id === wineId);
      if (!item) return;
      item.qty = Math.max(1, item.qty + delta);
      saveCart();
      renderCart();
    }

    function updateCartBadge() {
      const total = cart.reduce((s, c) => s + c.qty, 0);
      $('cartBadge').textContent = total || '';
    }

    function renderCart() {
      const el = $('cartContent');
      if (cart.length === 0) {
        el.innerHTML = `<div class="cart-empty">
          <svg viewBox="0 0 24 24"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4H6zm0 2h12l1.5 2H4.5L6 4zm-1 4h14v12H5V8zm5 3a3 3 0 0 0 6 0h-2a1 1 0 1 1-2 0H10z"/></svg>
          <h3>Carrinho vazio</h3>
          <p>Adicione vinhos a partir da harmonização ou do catálogo.</p>
        </div>`;
        updateCartBadge();
        return;
      }

      let total = 0;
      let itemsHtml = '';
      for (const ci of cart) {
        const w = allWines[ci.id];
        if (!w) continue;
        const subtotal = w.price * ci.qty;
        total += subtotal;
        itemsHtml += `
          <div class="cart-item">
            <div class="cart-item-info">
              ${wineTypeTag(w.type)}
              <div class="cart-item-name">${esc(w.name)}</div>
              <div class="cart-item-region">${esc(w.country)} — ${esc(w.region)}</div>
              <div class="cart-item-price">${formatBRL(w.price)} un.</div>
            </div>
            <div class="cart-qty">
              <button onclick="updateCartQty(${w.id},-1)">−</button>
              <span>${ci.qty}</span>
              <button onclick="updateCartQty(${w.id},+1)">+</button>
            </div>
            <div style="text-align:right;min-width:90px">
              <div style="font-weight:700;color:var(--gold)">${formatBRL(subtotal)}</div>
              <button class="cart-remove" onclick="removeFromCart(${w.id})">remover</button>
            </div>
          </div>`;
      }

      const orderText = cart.map(ci => {
        const w = allWines[ci.id];
        return w ? `${ci.qty}x ${w.fullName} - ${formatBRL(w.price)}` : '';
      }).filter(Boolean).join('%0A');

      el.innerHTML = itemsHtml + `
        <div class="cart-total-bar">
          <span class="cart-total-label">Total</span>
          <span class="cart-total-value">${formatBRL(total)}</span>
        </div>
        <a href="https://wa.me/?text=Olá! Gostaria de fazer o pedido:%0A${orderText}%0A%0ATotal: ${encodeURIComponent(formatBRL(total))}"
           target="_blank" rel="noopener" style="text-decoration:none">
          <button class="btn-whatsapp">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347z"/><path d="M12 0C5.373 0 0 5.373 0 12c0 2.625.846 5.059 2.284 7.034L.789 23.492a.5.5 0 0 0 .611.611l4.458-1.495A11.952 11.952 0 0 0 12 24c6.627 0 12-5.373 12-12S18.627 0 12 0zm0 22c-2.37 0-4.567-.68-6.43-1.852l-.448-.292-2.856.957.957-2.856-.292-.448A9.957 9.957 0 0 1 2 12C2 6.477 6.477 2 12 2s10 4.477 10 10-4.477 10-10 10z"/></svg>
            Enviar pedido via WhatsApp
          </button>
        </a>`;
      updateCartBadge();
    }

    // ================================================================
    //  RENDER WINE CARDS
    // ================================================================

    function renderWineCards(wines, container, showLimit) {
      const list = showLimit ? wines.slice(0, showLimit) : wines;
      container.innerHTML = list.map(w => `
        <div class="wine-card">
          ${wineTypeTag(w.type)}
          <div class="wine-card-name">${esc(w.name)}</div>
          <div class="wine-card-region">${esc(w.country)} — ${esc(w.region)}</div>
          ${w.grapes.length ? `<div class="wine-card-grapes">${esc(w.grapes.join(', '))}</div>` : ''}
          <div class="wine-card-bottom">
            <span class="wine-card-price">${formatBRL(w.price)}</span>
            <button class="btn-cart" onclick="handleAddToCart(this, ${w.id})">+ Carrinho</button>
          </div>
        </div>
      `).join('');
    }

    window.handleAddToCart = function(btn, id) {
      addToCart(id);
      btn.textContent = 'Adicionado';
      btn.classList.add('added');
      setTimeout(() => { btn.textContent = '+ Carrinho'; btn.classList.remove('added'); }, 1500);
    };

    // ================================================================
    //  RENDER RECIPE CARDS
    // ================================================================

    function renderRecipeCards(meals, container) {
      container.innerHTML = meals.map(m => `
        <div class="recipe-card">
          ${m.strMealThumb ? `<img src="${esc(m.strMealThumb)}" alt="${esc(m.strMeal)}" loading="lazy"/>` : ''}
          <div class="recipe-card-body">
            ${m.strCategory ? `<div class="recipe-card-cat">${esc(m.strCategory)}</div>` : ''}
            <div class="recipe-card-title">${esc(m.strMeal)}</div>
            ${m.strInstructions ? `<div class="recipe-card-desc">${esc(m.strInstructions.slice(0,140))}...</div>` : ''}
            ${m.strSource ? `<a class="recipe-link" href="${esc(m.strSource)}" target="_blank" rel="noopener">Ver receita completa →</a>` : ''}
          </div>
        </div>
      `).join('');
    }

    // ================================================================
    //  HARMONIZAR: VINHO → RECEITA
    // ================================================================

    async function harmonizeWineToRecipe() {
      const wineId = $('selWine').value;
      if (!wineId && wineId !== 0) return;
      const wine = allWines[parseInt(wineId)];
      if (!wine) return;

      const variation = document.querySelector('[data-var].active')?.dataset.var || 'all';
      const course = document.querySelector('[data-course].active')?.dataset.course || 'all';

      await withSpinner(async () => {
        // Determine categories to search
        let cats = [];

        if (course === 'entrada') cats = ['Starter','Side'];
        else if (course === 'sobremesa') cats = ['Dessert'];
        else if (variation !== 'all') cats = VARIATION_CATS[variation] || [];
        else cats = PAIR_WINE_TO_MEAL[wine.type]?.cats || ['Miscellaneous'];

        // If principal + variation, use variation cats
        if (course === 'principal' && variation !== 'all') {
          cats = VARIATION_CATS[variation] || cats;
        }

        // Fetch meals from all matching categories in parallel
        const promises = cats.map(c => filterByCategory(c).catch(() => []));
        const results = await Promise.all(promises);
        let allMeals = results.flat();

        // Pick random distinct meals, enrich with full details
        const shuffled = allMeals.sort(() => Math.random() - 0.5).slice(0, 6);
        const enriched = await Promise.all(
          shuffled.map(m => lookupMeal(m.idMeal).catch(() => null))
        );
        const meals = enriched.filter(Boolean);

        // Find matching wines for suggestions (same type, sorted by price)
        const suggestedWines = allWines
          .filter(w => w.id !== wine.id && w.type === wine.type)
          .sort((a, b) => a.price - b.price)
          .slice(0, 9);

        // Render
        const el = $('harmonResults');
        const tipLabel = TYPE_LABELS[wine.type] || wine.type;
        const pairingDesc = getPairingDescription(wine.type);

        el.innerHTML = `
          <div class="results-title">Pratos sugeridos para ${esc(wine.name)}</div>
          <p class="status-msg" style="margin-top:-12px;margin-bottom:20px">
            ${esc(tipLabel)}: ${esc(pairingDesc)}
          </p>
          <div class="recipe-grid" id="recipeResults"></div>
          <div class="suggestions-section">
            <div class="results-title">Vinhos do nosso catálogo para acompanhar</div>
            <p class="status-msg" style="margin-top:-12px;margin-bottom:20px">Ordenados por preço — do menor ao maior</p>
            <div class="wine-grid" id="wineSuggResults"></div>
          </div>
        `;

        if (meals.length) renderRecipeCards(meals, $('recipeResults'));
        else $('recipeResults').innerHTML = '<p class="status-msg">Nenhum prato encontrado para esta combinação.</p>';

        if (suggestedWines.length) renderWineCards(suggestedWines, $('wineSuggResults'));
        else $('wineSuggResults').innerHTML = '<p class="status-msg">Sem sugestões adicionais.</p>';
      });
    }

    function getPairingDescription(type) {
      const descs = {
        tinto: 'Ideal com carnes vermelhas, massas e queijos curados.',
        branco: 'Perfeito com peixes, frutos do mar e aves.',
        rose: 'Combina com pratos leves, saladas e cozinha mediterrânea.',
        espumante: 'Excelente com entradas, frutos do mar e celebrações.',
        porto: 'Clássico com sobremesas, chocolate e queijos azuis.',
        doce: 'Harmoniza com sobremesas e frutas.',
        outro: 'Versátil — acompanha diversos estilos de prato.'
      };
      return descs[type] || descs.outro;
    }

    // ================================================================
    //  HARMONIZAR: RECEITA → VINHO
    // ================================================================

    async function harmonizeRecipeToWine() {
      const term = $('inputRecipe').value.trim();
      if (!term) return;

      await withSpinner(async () => {
        const meals = await searchMeals(term);

        // Determine meal categories and find matching wine types
        const wineTypes = new Set();
        for (const m of meals) {
          const cat = m.strCategory || '';
          const types = PAIR_MEAL_TO_WINE[cat] || ['tinto', 'branco'];
          types.forEach(t => wineTypes.add(t));
        }
        if (wineTypes.size === 0) { wineTypes.add('tinto'); wineTypes.add('branco'); }

        const suggestedWines = allWines
          .filter(w => wineTypes.has(w.type))
          .sort((a, b) => a.price - b.price)
          .slice(0, 12);

        const el = $('harmonResults');

        el.innerHTML = `
          <div class="results-title">Receitas encontradas para "${esc(term)}"</div>
          <div class="recipe-grid" id="recipeResults"></div>
          <div class="suggestions-section">
            <div class="results-title">Vinhos sugeridos do nosso catálogo</div>
            <p class="status-msg" style="margin-top:-12px;margin-bottom:20px">Ordenados por preço — do menor ao maior</p>
            <div class="wine-grid" id="wineSuggResults"></div>
          </div>
        `;

        if (meals.length) renderRecipeCards(meals.slice(0, 6), $('recipeResults'));
        else $('recipeResults').innerHTML = '<p class="status-msg">Nenhuma receita encontrada. Tente outro termo.</p>';

        if (suggestedWines.length) renderWineCards(suggestedWines, $('wineSuggResults'));
        else $('wineSuggResults').innerHTML = '<p class="status-msg">Sem sugestões disponíveis.</p>';
      });
    }

    // ================================================================
    //  CATÁLOGO
    // ================================================================

    function renderCatalog() {
      const country = $('filterCountry').value;
      const region = $('filterRegion').value;
      const type = $('filterType').value;
      const search = $('filterSearch').value.toLowerCase().trim();

      let filtered = allWines.filter(w => {
        if (country && w.country !== country) return false;
        if (region && w.region !== region) return false;
        if (type && w.type !== type) return false;
        if (search && !w.fullName.toLowerCase().includes(search)) return false;
        return true;
      });

      filtered.sort((a, b) => a.price - b.price);

      $('catalogCount').textContent = `${filtered.length} vinho${filtered.length !== 1 ? 's' : ''} encontrado${filtered.length !== 1 ? 's' : ''}`;
      renderWineCards(filtered, $('catalogGrid'));
    }

    function populateCatalogFilters() {
      const countries = [...new Set(allWines.map(w => w.country))].sort();
      const regions = [...new Set(allWines.map(w => w.region).filter(Boolean))].sort();

      const cSel = $('filterCountry');
      cSel.innerHTML = '<option value="">Todos os países</option>' +
        countries.map(c => `<option value="${esc(c)}">${esc(c)}</option>`).join('');

      const rSel = $('filterRegion');
      rSel.innerHTML = '<option value="">Todas as regiões</option>' +
        regions.map(r => `<option value="${esc(r)}">${esc(r)}</option>`).join('');
    }

    // ================================================================
    //  POPULATE WINE SELECT
    // ================================================================

    function populateWineSelect() {
      const sel = $('selWine');
      sel.innerHTML = '<option value="">— escolha um rótulo —</option>';

      const sorted = [...allWines].sort((a, b) => a.name.localeCompare(b.name, 'pt-BR'));
      for (const w of sorted) {
        const opt = document.createElement('option');
        opt.value = w.id;
        opt.textContent = `${w.name} — ${formatBRL(w.price)}`;
        sel.appendChild(opt);
      }
    }

    // ================================================================
    //  EVENTS
    // ================================================================

    $('btnHarmonizar').addEventListener('click', harmonizeWineToRecipe);
    $('btnFindRecipe').addEventListener('click', harmonizeRecipeToWine);
    $('inputRecipe').addEventListener('keydown', e => { if (e.key === 'Enter') harmonizeRecipeToWine() });

    $('filterCountry').addEventListener('change', renderCatalog);
    $('filterRegion').addEventListener('change', renderCatalog);
    $('filterType').addEventListener('change', renderCatalog);
    $('filterSearch').addEventListener('input', renderCatalog);

    // ================================================================
    //  INIT
    // ================================================================

    async function init() {
      try {
        const raw = await fetch('vinhos.json').then(r => r.json());
        allWines = processWines(raw);
      } catch (e) {
        console.error('Erro ao carregar vinhos.json:', e);
        allWines = [];
      }

      populateWineSelect();
      populateCatalogFilters();
      renderCatalog();
      renderCart();
      updateCartBadge();
    }

    init();
  </script>
</body>
</html>
