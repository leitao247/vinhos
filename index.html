<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Catálogo S&P — Verificação Completa</title>
  <style>
    :root{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial}
    body{max-width:1200px;margin:20px auto;padding:18px;background:#f6f7fb;color:#111}
    header{display:flex;justify-content:space-between;align-items:center;gap:12px}
    h1{margin:0;font-size:1.25rem}
    .controls{display:flex;gap:8px;align-items:center}
    input,select,button{padding:8px;border:1px solid #d1d5db;border-radius:6px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px;margin-top:16px}
    .card{background:#fff;padding:12px;border-radius:8px;box-shadow:0 1px 6px rgba(16,24,40,.06)}
    .thumb{height:160px;background:#f3f4f6;border-radius:6px;display:flex;align-items:center;justify-content:center;overflow:hidden}
    .thumb img{width:100%;height:100%;object-fit:cover}
    .muted{color:#6b7280;font-size:0.9rem}
    #debug{margin-top:12px;background:#fff;padding:10px;border-radius:6px;box-shadow:0 1px 4px rgba(0,0,0,.04)}
    pre{white-space:pre-wrap;word-break:break-word}
  </style>
</head>
<body>
  <header>
    <div>
      <h1>Catálogo S&P — Verificação</h1>
      <div class="muted">Confirme se aparecem todos os produtos. Contador e logs ajudam a diagnosticar.</div>
    </div>

    <div class="controls">
      <input id="search" placeholder="Pesquisar código, nome ou família" style="width:300px" />
      <select id="filterFamily"><option value="">Todas as famílias</option></select>
      <button id="btnExport">Exportar JSON</button>
    </div>
  </header>

  <div id="debug" aria-live="polite">
    <div><strong>Total esperado:</strong> <span id="expectedCount">56</span></div>
    <div><strong>Total carregado:</strong> <span id="loadedCount">0</span></div>
    <div class="muted small">Se o número carregado for menor que o esperado, abra o console do navegador (F12) e verifique erros.</div>
    <details style="margin-top:8px"><summary>Logs de depuração</summary><pre id="logArea">—</pre></details>
  </div>

  <main id="mainGrid" class="grid" aria-live="polite"></main>

  <hr style="margin:18px 0" />

  <section class="card">
    <strong>Dados brutos (JSON embutido)</strong>
    <pre id="rawData" style="max-height:320px;overflow:auto"></pre>
  </section>

  <script>
    /*************************************************************************
     * ATENÇÃO
     * - Verifique o valor em #expectedCount e ajuste se necessário.
     * - Se aparecerem menos itens, abra o console (F12) e veja mensagens.
     *************************************************************************/

    // === DADOS (resumido aqui; substitua pelo array completo que você já tem) ===
    // Para evitar truncamento acidental, garanta que PRODUCTS contenha todos os objetos.
    const PRODUCTS = [
      /* Cole aqui o array completo de produtos (todos os objetos). 
         Exemplo de item:
         {"code":"3000211","product":"Gaggiarone ...","family":"Gaggiarone","vintage":"2021","pack":"6 / 750mL","price":820.44},
         ... (todos os itens)
      */
    ];

    // === UTILITÁRIOS ===
    const mainGrid = document.getElementById('mainGrid');
    const rawData = document.getElementById('rawData');
    const searchInput = document.getElementById('search');
    const filterFamily = document.getElementById('filterFamily');
    const btnExport = document.getElementById('btnExport');
    const loadedCountEl = document.getElementById('loadedCount');
    const logArea = document.getElementById('logArea');
    const expectedCountEl = document.getElementById('expectedCount');

    // Ajuste visual do número esperado (se você sabe que são 56, mantenha; senão altere)
    const EXPECTED_COUNT = 56;
    expectedCountEl.textContent = EXPECTED_COUNT;

    function log(...args){
      console.log(...args);
      const line = args.map(a => (typeof a === 'object' ? JSON.stringify(a) : String(a))).join(' ');
      if(logArea.textContent === '—') logArea.textContent = '';
      logArea.textContent += line + '\\n';
    }

    function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

    function imageUrlFor(code){ return `images/${code}.jpg`; }

    function handleImgError(img){
      if(img.dataset.tried === 'jpg'){
        if(!img.dataset.triedPng){
          img.dataset.triedPng = '1';
          img.src = img.src.replace(/\\.jpg$/i, '.png');
        } else {
          img.src = placeholderDataUrl();
        }
      } else {
        img.dataset.tried = 'jpg';
        // trigger onerror again (browser will call onerror if src fails)
        img.src = img.src;
      }
    }

    function placeholderDataUrl(){
      return 'data:image/svg+xml;utf8,' + encodeURIComponent(
        `<svg xmlns="http://www.w3.org/2000/svg" width="600" height="400"><rect width="100%" height="100%" fill="#f3f4f6"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#9ca3af" font-family="Arial" font-size="20">Imagem não disponível</text></svg>`
      );
    }

    function createCard(item){
      const div = document.createElement('div');
      div.className = 'card';
      div.tabIndex = 0;
      div.innerHTML = `
        <div class="thumb"><img alt="${escapeHtml(item.product)}" src="${imageUrlFor(item.code)}" onerror="handleImgError(this)" /></div>
        <div>
          <div style="display:flex;justify-content:space-between;align-items:center">
            <strong>${escapeHtml(item.product)}</strong>
            <span class="muted">${escapeHtml(item.code)}</span>
          </div>
          <div class="muted" style="margin-top:6px">${item.vintage || '—'} • ${escapeHtml(item.pack)} • R$ ${item.price !== null ? Number(item.price).toFixed(2) : '—'}</div>
        </div>
      `;
      return div;
    }

    // === RENDERIZAÇÃO SEM LIMITES ===
    function render(list){
      mainGrid.innerHTML = '';
      if(!Array.isArray(list)) list = [];
      loadedCountEl.textContent = list.length;
      log('Renderizando', list.length, 'itens');
      if(list.length === 0){
        mainGrid.innerHTML = '<div class="muted">Nenhum produto encontrado.</div>';
        rawData.textContent = JSON.stringify(list, null, 2);
        return;
      }
      // Renderiza todos os itens (sem paginação)
      const frag = document.createDocumentFragment();
      for(const item of list){
        frag.appendChild(createCard(item));
      }
      mainGrid.appendChild(frag);
      rawData.textContent = JSON.stringify(list, null, 2);
    }

    // === FILTROS E EXPORT ===
    function populateFamilies(){
      const families = Array.from(new Set(PRODUCTS.map(p=>p.family || 'Outros'))).sort();
      for(const f of families){
        const opt = document.createElement('option');
        opt.value = f;
        opt.textContent = f;
        filterFamily.appendChild(opt);
      }
    }

    function applyFilters(){
      const q = searchInput.value.trim().toLowerCase();
      const fam = filterFamily.value;
      let list = PRODUCTS.slice();
      if(fam) list = list.filter(p => (p.family || '').toLowerCase() === fam.toLowerCase());
      if(q){
        list = list.filter(p => {
          return (p.code && p.code.toLowerCase().includes(q)) ||
                 (p.product && p.product.toLowerCase().includes(q)) ||
                 (p.family && p.family.toLowerCase().includes(q));
        });
      }
      render(list);
    }

    searchInput.addEventListener('input', applyFilters);
    filterFamily.addEventListener('change', applyFilters);

    btnExport.addEventListener('click', ()=>{
      const w = window.open('', '_blank');
      w.document.write('<pre>' + escapeHtml(JSON.stringify(PRODUCTS, null, 2)) + '</pre>');
      w.document.title = 'Export JSON';
    });

    // === INICIALIZAÇÃO E VERIFICAÇÃO ===
    (function init(){
      try{
        log('Inicializando catálogo...');
        // Basic sanity checks
        if(!Array.isArray(PRODUCTS)){
          throw new Error('VARIÁVEL PRODUCTS não é um array. Verifique se você colou o array completo.');
        }
        log('PRODUCTS length =', PRODUCTS.length);
        // Atualiza contador esperado visualmente (se quiser ajustar)
        loadedCountEl.textContent = 0;
        populateFamilies();
        render(PRODUCTS);
        // Se houver discrepância, logue aviso
        if(PRODUCTS.length !== EXPECTED_COUNT){
          log('Aviso: número de itens carregados (' + PRODUCTS.length + ') difere do esperado (' + EXPECTED_COUNT + ').');
        } else {
          log('Contagem conferida: OK.');
        }
      } catch(err){
        log('Erro na inicialização:', err.message || err);
        mainGrid.innerHTML = '<div class="muted">Erro ao inicializar catálogo. Veja o console para detalhes.</div>';
      }
    })();

    // Expor para depuração
    window.PRODUCTS = PRODUCTS;
    window.logArea = logArea;
    window.handleImgError = handleImgError;
  </script>
</body>
</html>
